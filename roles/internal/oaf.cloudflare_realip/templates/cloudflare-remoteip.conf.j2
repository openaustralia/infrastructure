# Cloudflare Real IP Configuration for Apache
# Generated by Ansible role: oaf.cloudflare_realip
# Last updated: {{ ansible_date_time.iso8601 }}
#
# This file configures Apache's mod_remoteip to restore the real client IP
# address when traffic is proxied through Cloudflare. Without this config,
# %a and %h in logs will show Cloudflare IPs instead of client IPs.
#
# Documentation: https://developers.cloudflare.com/fundamentals/reference/http-headers/

<IfModule mod_remoteip.c>
    # Use the CF-Connecting-IP header to get the real client IP
    RemoteIPHeader {{ cloudflare_real_ip_header }}

    # Cloudflare IPv4 ranges
{% for cidr in cloudflare_ipv4_cidrs %}
    RemoteIPTrustedProxy {{ cidr }}
{% endfor %}

{% if cloudflare_ipv6_cidrs %}
    # Cloudflare IPv6 ranges
{% for cidr in cloudflare_ipv6_cidrs %}
    RemoteIPTrustedProxy {{ cidr }}
{% endfor %}
{% endif %}
</IfModule>
