# Cloudflare Real IP Configuration
# Generated by Ansible role: oaf.cloudflare_realip
# Last updated: {{ ansible_date_time.iso8601 }}
#
# This file configures nginx to restore the real client IP address
# when traffic is proxied through Cloudflare. Without this config,
# $remote_addr will contain a Cloudflare IP instead of the client IP.
#
# Include this file in your nginx http block or use conf.d auto-loading.
#
# Documentation: https://developers.cloudflare.com/fundamentals/reference/http-headers/

# Cloudflare IPv4 ranges
{% for cidr in cloudflare_ipv4_cidrs %}
set_real_ip_from {{ cidr }};
{% endfor %}

{% if cloudflare_ipv6_cidrs %}
# Cloudflare IPv6 ranges
{% for cidr in cloudflare_ipv6_cidrs %}
set_real_ip_from {{ cidr }};
{% endfor %}

{% endif %}
# Use the CF-Connecting-IP header to get the real client IP
# This is the recommended header from Cloudflare
real_ip_header {{ cloudflare_real_ip_header }};

# Only replace the client IP if the request comes from a trusted proxy
# With the set_real_ip_from directives above, nginx will only trust
# these specific Cloudflare IP ranges
real_ip_recursive on;
