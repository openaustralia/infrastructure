#!/bin/bash
# This file was generated by Ansible for {{ ansible_fqdn }}
# Do NOT modify this file by hand!
#
# Restic backup script for {{ profile.name }}

set -euo pipefail

# Load environment
source {{ restic_config_dir }}/{{ profile.name }}.env

LOGFILE={{ restic_log_dir }}/{{ profile.name }}.log
LOCKFILE=/var/run/restic-backup-{{ profile.name }}.lock
DAY_OF_WEEK=$(date +%u)

mkdir -p {{ restic_log_dir }}

# Prevent concurrent runs
if [ -f "$LOCKFILE" ]; then
    echo "Backup already running (lockfile exists)" >&2
    exit 1
fi
trap "rm -f $LOCKFILE" EXIT
touch "$LOCKFILE"

exec >> $LOGFILE 2>&1

echo "========================================"
echo "Backup started: $(date)"
echo "========================================"

# Run backup with compression
restic backup {{ profile.source }} \
{% for exclude in profile.exclude | default([]) %}
    --exclude='{{ exclude }}' \
{% endfor %}
    --compression {{ profile.compression | default(restic_compression) }} \
    --verbose

# Only prune on configured day (default Sunday = 7)
if [ "$DAY_OF_WEEK" -eq {{ profile.prune_day | default(restic_prune_day) }} ]; then
    echo ""
    echo "Running forget/prune..."
    restic forget \
        --keep-daily {{ profile.keep_daily | default(restic_keep_daily) }} \
        --keep-weekly {{ profile.keep_weekly | default(restic_keep_weekly) }} \
        --keep-monthly {{ profile.keep_monthly | default(restic_keep_monthly) }} \
        --prune

    echo ""
    echo "Running integrity check..."
    restic check
fi

echo ""
echo "Backup completed: $(date)"
echo "========================================"
